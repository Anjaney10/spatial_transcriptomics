```{r}
library(Seurat)
library(clusterProfiler)
library(org.Hs.eg.db)
library(dplyr)

# Seurat v5 helper: safely rename features across layers for an Assay5
RenameFeaturesSeurat5 <- function(object, assay = "RNA", mapping_df,
                  from_col = "ENSEMBL", to_col = "SYMBOL",
                  layers = c("counts", "data")) {
  stopifnot(inherits(object, "Seurat"))
  stopifnot(assay %in% Assays(object))
  stopifnot(all(c(from_col, to_col) %in% colnames(mapping_df)))

  # Clean mapping: valid target symbols; 1:1 on source keys
  map <- mapping_df %>%
  dplyr::select(dplyr::all_of(c(from_col, to_col))) %>%
  dplyr::filter(!is.na(.data[[to_col]]), .data[[to_col]] != "") %>%
  dplyr::distinct(.data[[from_col]], .keep_all = TRUE)

  # Function to rename one layer matrix
  rename_layer <- function(mat) {
  old <- rownames(mat)
  new <- map[[to_col]][match(old, map[[from_col]])]
  new[is.na(new) | new == ""] <- old
  new <- make.unique(as.character(new))
  rownames(mat) <- new
  mat
  }

  # Rename requested layers if they exist
  for (lyr in layers) {
  mat <- tryCatch(
    LayerData(object, assay = assay, layer = lyr),
    error = function(e) NULL
  )
  if (!is.null(mat)) {
    mat2 <- rename_layer(mat)
    LayerData(object, assay = assay, layer = lyr) <- mat2
  }
  }

  # Keep VariableFeatures consistent (VariableFeatures() is per-assay in Seurat v5)
  vf <- tryCatch(VariableFeatures(object[[assay]]), error = function(e) character(0))
  if (length(vf) > 0) {
  vf_new <- map[[to_col]][match(vf, map[[from_col]])]
  vf_new[is.na(vf_new) | vf_new == ""] <- vf
  VariableFeatures(object[[assay]]) <- make.unique(as.character(vf_new))
  }

  # Rebuild meta.features (Seurat v5 expects feature-level metadata keyed by rownames)
  feats <- tryCatch(rownames(LayerData(object, assay = assay, layer = "counts")), error = function(e) NULL)
  if (is.null(feats)) {
  feats <- tryCatch(rownames(LayerData(object, assay = assay, layer = "data")), error = function(e) NULL)
  }
  if (!is.null(feats)) {
  object[[assay]]@meta.features <- data.frame(row.names = feats)
  }

  object
}

# ---- Build ENSEMBL -> SYMBOL mapping from current RNA features (Seurat v5) ----
# Prefer counts features; fallback to data
ref_features <- tryCatch(
  rownames(LayerData(ref, assay = "RNA", layer = "counts")),
  error = function(e) rownames(LayerData(ref, assay = "RNA", layer = "data"))
)

# If Ensembl IDs contain version suffix (e.g., ENSG... .12), strip it for mapping
ref_features_stripped <- sub("\\.\\d+$", "", ref_features)

mapping <- clusterProfiler::bitr(
  ref_features_stripped,
  fromType = "ENSEMBL",
  toType   = "SYMBOL",
  OrgDb    = org.Hs.eg.db
)

# Ensure mapping has the same ENSEMBL key format as features (stripped)
mapping$ENSEMBL <- sub("\\.\\d+$", "", mapping$ENSEMBL)

# ---- Apply rename across layers (no scale.data assumed) ----
# Only rename layers that exist; do NOT touch scale.data
ref <- RenameFeaturesSeurat5(
  object = ref,
  assay = "RNA",
  mapping_df = mapping,
  from_col = "ENSEMBL",
  to_col = "SYMBOL",
  layers = c("counts", "data")  # add other existing layers here if needed
)

# ---- Minimal validation ----
counts_rn <- tryCatch(rownames(LayerData(ref, "RNA", "counts")), error = function(e) NULL)
data_rn   <- tryCatch(rownames(LayerData(ref, "RNA", "data")),   error = function(e) NULL)

if (!is.null(counts_rn)) {
  message("Duplicates in counts: ", sum(duplicated(counts_rn)))
  message("NA in counts: ", sum(is.na(counts_rn)))
}
if (!is.null(data_rn)) {
  message("Duplicates in data: ", sum(duplicated(data_rn)))
  message("NA in data: ", sum(is.na(data_rn)))
}
if (!is.null(counts_rn) && !is.null(data_rn)) {
  message("counts/data rownames identical: ", isTRUE(all.equal(counts_rn, data_rn)))
}
```
